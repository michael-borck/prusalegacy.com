<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Borck">

<title>Prusa Legacy Update Hub - Building a Modernized Prusa Mendel (Iteration 2) in 2024: A Proof of Concept</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Prusa Legacy Update Hub</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-about" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">About</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-about">    
        <li>
    <a class="dropdown-item" href="../about/site.html">
 <span class="dropdown-text">Site</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../about/founder.html">
 <span class="dropdown-text">Founder</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-d-printers" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">3D Printers</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-d-printers">    
        <li>
    <a class="dropdown-item" href="../printers/mk3.html">
 <span class="dropdown-text">Prusa i3 MK3/S/+</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../printers/mk2.html">
 <span class="dropdown-text">Prusa MK2/2.5S/3S</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../printers/mini.html">
 <span class="dropdown-text">Prusa MINI+</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../printers/clones.html">
 <span class="dropdown-text">Clones</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../materials.html"> 
<span class="menu-text">Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../firmware.html"> 
<span class="menu-text">Firmware</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../community.html"> 
<span class="menu-text">Community</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-foundation-prusa-mendel-i2-frame" id="toc-the-foundation-prusa-mendel-i2-frame" class="nav-link active" data-scroll-target="#the-foundation-prusa-mendel-i2-frame">The Foundation: Prusa Mendel (i2) Frame</a></li>
  <li><a href="#modern-hot-end-e3d-v6" id="toc-modern-hot-end-e3d-v6" class="nav-link" data-scroll-target="#modern-hot-end-e3d-v6">Modern Hot-End: E3D V6</a></li>
  <li><a href="#advanced-bed-leveling-superpinda" id="toc-advanced-bed-leveling-superpinda" class="nav-link" data-scroll-target="#advanced-bed-leveling-superpinda">Advanced Bed Leveling: SuperPINDA</a></li>
  <li><a href="#filament-sensor-and-12v-heat-bed" id="toc-filament-sensor-and-12v-heat-bed" class="nav-link" data-scroll-target="#filament-sensor-and-12v-heat-bed">Filament Sensor and 12V Heat Bed</a></li>
  <li><a href="#control-board-ramps-with-2004-lcd" id="toc-control-board-ramps-with-2004-lcd" class="nav-link" data-scroll-target="#control-board-ramps-with-2004-lcd">Control Board: RAMPS with 2004 LCD</a></li>
  <li><a href="#klipper-and-input-shaping" id="toc-klipper-and-input-shaping" class="nav-link" data-scroll-target="#klipper-and-input-shaping">Klipper and Input Shaping</a></li>
  <li><a href="#cost-effectiveness-and-purpose" id="toc-cost-effectiveness-and-purpose" class="nav-link" data-scroll-target="#cost-effectiveness-and-purpose">Cost-Effectiveness and Purpose</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Building a Modernized Prusa Mendel (Iteration 2) in 2024: A Proof of Concept</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Michael Borck </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p>In the world of 3D printing, the Prusa Mendel (iteration 2) holds a special place as one of the pioneering designs that helped popularize desktop 3D printing. While it may be considered outdated by today’s standards, there’s an intriguing challenge in modernizing this classic design with contemporary components. This article explores the concept of building an updated Prusa Mendel (i2) in 2024, not as a cost-effective solution, but as a proof of concept demonstrating that quality prints can be achieved with any printer design when equipped with modern technology.</p>
<section id="the-foundation-prusa-mendel-i2-frame" class="level2">
<h2 class="anchored" data-anchor-id="the-foundation-prusa-mendel-i2-frame">The Foundation: Prusa Mendel (i2) Frame</h2>
<p>The core of this build remains the iconic triangular frame of the Prusa Mendel (i2). This design, while dated, provides a solid foundation for our modernization efforts. We’ll retain the original frame geometry and motor placements, which will serve as a familiar starting point for those acquainted with the i2 design.</p>
</section>
<section id="modern-hot-end-e3d-v6" class="level2">
<h2 class="anchored" data-anchor-id="modern-hot-end-e3d-v6">Modern Hot-End: E3D V6</h2>
<p>One of the most significant upgrades in this build is the incorporation of the E3D V6 hot-end. This all-metal hot-end is known for its reliability and versatility, capable of handling a wide range of filaments at higher temperatures. The E3D V6 will greatly enhance the printer’s capabilities, allowing for experimentation with more advanced materials that weren’t feasible with the original i2 design[3].</p>
</section>
<section id="advanced-bed-leveling-superpinda" class="level2">
<h2 class="anchored" data-anchor-id="advanced-bed-leveling-superpinda">Advanced Bed Leveling: SuperPINDA</h2>
<p>To improve print bed adhesion and first layer quality, we’ll be integrating a SuperPINDA probe. This advanced bed leveling sensor offers improved temperature stability and accuracy compared to the original PINDA probe, ensuring consistent and precise bed leveling across various printing conditions[7].</p>
</section>
<section id="filament-sensor-and-12v-heat-bed" class="level2">
<h2 class="anchored" data-anchor-id="filament-sensor-and-12v-heat-bed">Filament Sensor and 12V Heat Bed</h2>
<p>Adding a filament sensor will help prevent print failures due to filament runout or jams. For the print bed, we’ll be using a 12V heat bed, which, while not as quick to heat as some modern 24V options, will still provide adequate heating for most common filaments.</p>
</section>
<section id="control-board-ramps-with-2004-lcd" class="level2">
<h2 class="anchored" data-anchor-id="control-board-ramps-with-2004-lcd">Control Board: RAMPS with 2004 LCD</h2>
<p>For the brain of our modernized i2, we’ll be using a RAMPS (RepRap Arduino Mega Pololu Shield) board paired with a 2004 LCD display. This combination offers a good balance of functionality and compatibility with our chosen components. To give the printer a more Prusa-like feel, we’ll be using modified Prusa firmware, which will provide a familiar interface for those accustomed to Prusa printers[8].</p>
</section>
<section id="klipper-and-input-shaping" class="level2">
<h2 class="anchored" data-anchor-id="klipper-and-input-shaping">Klipper and Input Shaping</h2>
<p>To truly bring this printer into 2024, we’ll be implementing Klipper firmware along with input shaping. Klipper allows for offloading complex calculations to a more powerful host computer, potentially improving print speeds and quality. Input shaping, a feature of Klipper, can help reduce ringing and ghosting in prints, compensating for some of the inherent vibrations in the i2’s frame design.</p>
</section>
<section id="cost-effectiveness-and-purpose" class="level2">
<h2 class="anchored" data-anchor-id="cost-effectiveness-and-purpose">Cost-Effectiveness and Purpose</h2>
<p>It’s important to note that this build is not intended to be cost-effective. In fact, the cost of modernizing a Prusa Mendel (i2) with these components will likely exceed that of many current, more capable 3D printers. The purpose of this build is purely as a proof of concept, demonstrating that with the right modern components and firmware, even an older design can produce high-quality prints.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Building a modernized Prusa Mendel (i2) in 2024 is an interesting exercise in combining classic design with contemporary technology. While not practical from a cost or efficiency standpoint, it serves as a testament to the adaptability of 3D printer designs and the rapid advancements in 3D printing technology. This project showcases that with the right upgrades - a modern hot-end like the E3D V6, advanced bed leveling with SuperPINDA, and cutting-edge firmware like Klipper with input shaping - even a printer design from over a decade ago can produce prints that rival those of modern machines.</p>
<p>For those interested in 3D printing history or looking for a unique project, this modernized i2 build offers a blend of nostalgia and current technology. However, for those seeking a practical, cost-effective 3D printing solution, there are many modern printers available that offer superior performance out of the box without the need for extensive modifications.</p>
<p>Citations: [1] https://reprap.org/wiki/Prusa_Mendel_%28iteration_2%29 [2] https://reprap.org/wiki/Prusa_Mendel [3] https://e3d-online.com/products/v6-all-metal-hotend [4] https://www.3dprintergear.com.au/prusa-super-pinda-bed-levelling-probe [5] https://www.ebay.com.au/itm/254630578105 [6] https://forum.prusa3d.com/forum/original-prusa-i3-mk3s-mk3-hardware-firmware-and-software-help/how-do-i-modify-the-firmware-to-allow-a-taller-nozzle-to-work/ [7] https://forum.prusa3d.com/forum/original-prusa-i3-mk3s-mk3-hardware-firmware-and-software-help/super-pinda-setup/ [8] https://forum.prusa3d.com/forum/original-prusa-i3-mk3s-mk3-prusa-i3-kit-archive/ramps-1.4-lcd-to-rambo-mini/ [9] https://www.reddit.com/r/Reprap/comments/gjghdv/prusa_mendel_i2_build/ [10] https://www.3dprintedparts.com/2021/01/15/how-is-3d-printing-cost-effective/ [11] https://www.ignitec.com/insights/are-3d-printing-costs-expensive-and-is-it-a-viable-manufacturing-option/</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/prusalegacy\.com\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>